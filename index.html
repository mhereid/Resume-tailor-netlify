<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Resume Tailor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
    }

    .layout {
      display: grid;
      grid-template-columns: 220px 1fr;
      height: 100vh;
    }

    .sidebar {
      background: #020617;
      padding: 1rem;
      border-right: 1px solid #1e293b;
    }

    .sidebar a {
      display: block;
      padding: 0.5rem;
      color: #cbd5f5;
      text-decoration: none;
      border-radius: 6px;
      margin-bottom: 0.25rem;
      cursor: pointer;
    }

    .sidebar a.active,
    .sidebar a:hover {
      background: #1e293b;
      color: #fff;
    }

    .main {
      padding: 1.25rem;
      overflow-y: auto;
    }

    h1 {
      margin-top: 0;
    }

    input, textarea, button {
      width: 100%;
      margin-top: 0.5rem;
      background: #020617;
      color: #e5e7eb;
      border: 1px solid #334155;
      border-radius: 6px;
      padding: 0.6rem;
      font-size: 0.9rem;
    }

    textarea {
      min-height: 320px;
      white-space: pre-wrap;
    }

    button {
      cursor: pointer;
      background: #f59e0b;
      color: #020617;
      font-weight: 600;
    }

    .hidden {
      display: none;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    th, td {
      border-bottom: 1px solid #334155;
      padding: 0.6rem;
      text-align: left;
      font-size: 0.85rem;
    }

    th {
      color: #fbbf24;
      font-weight: 600;
    }

    a.link {
      color: #38bdf8;
      text-decoration: none;
    }
  </style>
</head>

<body>
<div class="layout">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <a id="nav-generate" class="active">Tailor Resume</a>
    <a id="nav-history">History</a>
  </aside>

  <!-- MAIN -->
  <main class="main">

    <!-- GENERATE VIEW -->
    <section id="generate-view">
      <h1>Generate Tailored Resume</h1>

      <label>Job Posting URL</label>
      <input id="jobUrl" placeholder="https://company.com/job/123" />

      <label>Mode</label>
      <select id="mode">
        <option value="full">Full</option>
        <option value="one_page">One Page</option>
      </select>

      <button id="generateBtn">Generate</button>

      <label>Output</label>
      <textarea id="output"></textarea>
    </section>

    <!-- HISTORY VIEW -->
    <section id="history-view" class="hidden">
      <h1>History</h1>
      <table>
        <thead>
          <tr>
            <th>Company / Role</th>
            <th>Link</th>
            <th>Model</th>
            <th>Created</th>
          </tr>
        </thead>
        <tbody id="historyTable"></tbody>
      </table>
    </section>

  </main>
</div>

<script>
/* ------------------------
   NAVIGATION
------------------------- */
const navGenerate = document.getElementById("nav-generate");
const navHistory = document.getElementById("nav-history");
const generateView = document.getElementById("generate-view");
const historyView = document.getElementById("history-view");

navGenerate.onclick = () => {
  navGenerate.classList.add("active");
  navHistory.classList.remove("active");
  generateView.classList.remove("hidden");
  historyView.classList.add("hidden");
};

navHistory.onclick = () => {
  navHistory.classList.add("active");
  navGenerate.classList.remove("active");
  generateView.classList.add("hidden");
  historyView.classList.remove("hidden");
  loadHistory();
};

/* ------------------------
   GENERATE
------------------------- */
document.getElementById("generateBtn").onclick = async () => {
  const jobUrl = document.getElementById("jobUrl").value.trim();
  const mode = document.getElementById("mode").value;
  const output = document.getElementById("output");

  output.value = "Generatingâ€¦";

  const res = await fetch("/.netlify/functions/tailor-resume", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ jobUrl, mode })
  });

  const data = await res.json();

  // ðŸ”´ THIS IS THE CRITICAL LINE THAT WAS BROKEN BEFORE
  output.value = data.resume || "";
};

/* ------------------------
   HISTORY
------------------------- */
async function loadHistory() {
  const table = document.getElementById("historyTable");
  table.innerHTML = "<tr><td colspan='4'>Loadingâ€¦</td></tr>";

  const res = await fetch("/.netlify/functions/history");
  const data = await res.json();

  if (!data.history || data.history.length === 0) {
    table.innerHTML = "<tr><td colspan='4'>No history yet</td></tr>";
    return;
  }

  table.innerHTML = "";

  data.history.forEach(h => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${h.company || "N/A"}</td>
      <td><a class="link" href="${h.jobUrl}" target="_blank">Link</a></td>
      <td>${h.modelUsed}</td>
      <td>${new Date(h.createdAt).toLocaleString()}</td>
    `;

    tr.onclick = () => {
      navGenerate.onclick();
      document.getElementById("jobUrl").value = h.jobUrl;
      document.getElementById("mode").value = h.mode;
      document.getElementById("output").value = h.output;
    };

    table.appendChild(tr);
  });
}
</script>

</body>
</html>
